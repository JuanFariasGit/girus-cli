#!/bin/bash

set -e

echo "=== Instalando o Girus CLI ==="

# Detectar sistema operacional
OS="linux"
if [[ "$OSTYPE" == "darwin"* ]]; then
OS="darwin"
elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" || "$OSTYPE" == "cygwin" ]]; then
OS="windows"
fi

# Detectar arquitetura
ARCH=$(uname -m)
if [ "$ARCH" == "x86_64" ]; then
ARCH="amd64"
elif [[ "$ARCH" == "arm64" || "$ARCH" == "aarch64" ]]; then
ARCH="arm64"
fi

echo "Sistema operacional detectado: $OS"
echo "Arquitetura detectada: $ARCH"

# URL base para os binários do Girus CLI
RELEASE_VERSION="0.1.0"
RELEASES_URL="https://github.com/badtuxx/girus-cli/releases/download/v${RELEASE_VERSION}/girus-${OS}-${ARCH}"

# Armazenar o diretório atual
ORIGINAL_DIR=$(pwd)
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# Função para baixar e instalar o binário
download_and_install() {
local binary_name="girus"

# No Windows, adicionar extensão .exe
if [ "$OS" == "windows" ]; then
binary_name="girus.exe"
fi

# Construir a URL do binário
local binary_url="${RELEASES_URL}/girus-${OS}-${ARCH}"

echo "Baixando Girus CLI para ${OS}-${ARCH}..."

# Tentar baixar com curl ou wget
if command -v curl &> /dev/null; then
curl -L -o "$binary_name" "$binary_url"
elif command -v wget &> /dev/null; then
wget -O "$binary_name" "$binary_url"
else
echo "❌ Erro: Nem curl nem wget estão instalados. Por favor, instale um deles e tente novamente."
exit 1
fi

# Verificar se o download foi bem-sucedido
if [ ! -f "$binary_name" ]; then
echo "❌ Erro: Falha ao baixar o binário do Girus CLI."

# Informar ao usuário sobre a possibilidade de compilar do código-fonte
echo "Binário pré-compilado não disponível para ${OS}-${ARCH}."
echo "Você pode tentar compilar manualmente do código-fonte:"
echo "1. git clone https://github.com/linuxtips/girus-cli.git"
echo "2. cd girus-cli"
echo "3. go build -o girus ."

exit 1
fi

# Dar permissão de execução (exceto no Windows)
if [ "$OS" != "windows" ]; then
chmod +x "$binary_name"
fi

echo "Girus CLI baixado com sucesso."
}

# Verificar se Kind está instalado
check_and_install_kind() {
if ! command -v kind &> /dev/null; then
echo "Kind não está instalado."
read -p "Deseja instalar Kind automaticamente? (S/n): " INSTALL_KIND
INSTALL_KIND=${INSTALL_KIND:-S}

if [[ "$INSTALL_KIND" =~ ^[Ss]$ ]]; then
install_kind
else
echo "Aviso: Kind não está instalado. É necessário para criar clusters."
echo "Visite: https://kind.sigs.k8s.io/docs/user/quick-start/#installation"
fi
else
echo "✅ Kind encontrado."
fi
}

# Função para instalar Kind
install_kind() {
echo "Instalando Kind..."

if [ "$OS" == "linux" ] || [ "$OS" == "darwin" ]; then
# Linux/Mac
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-$(uname)-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind

elif [ "$OS" == "windows" ]; then
# Windows
echo "Instalação automática do Kind não suportada no Windows."
echo "Por favor, baixe e instale Kind manualmente:"
echo "https://kind.sigs.k8s.io/docs/user/quick-start/#installation"
echo "Após a instalação, reabra o terminal e execute este script novamente."
exit 1
fi

# Verificar a instalação
if ! command -v kind &> /dev/null; then
echo "Falha ao instalar o Kind. Por favor, instale manualmente."
exit 1
fi

echo "Kind instalado com sucesso!"
}

# Verificar se Kubectl está instalado
check_and_install_kubectl() {
if ! command -v kubectl &> /dev/null; then
echo "Kubectl não está instalado."
read -p "Deseja instalar Kubectl automaticamente? (S/n): " INSTALL_KUBECTL
INSTALL_KUBECTL=${INSTALL_KUBECTL:-S}

if [[ "$INSTALL_KUBECTL" =~ ^[Ss]$ ]]; then
install_kubectl
else
echo "Aviso: Kubectl não está instalado. É necessário para gerenciar clusters."
echo "Visite: https://kubernetes.io/docs/tasks/tools/install-kubectl/"
fi
else
echo "✅ Kubectl encontrado."
fi
}

# Função para instalar Kubectl
install_kubectl() {
echo "Instalando Kubectl..."

if [ "$OS" == "linux" ]; then
# Linux
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

elif [ "$OS" == "darwin" ]; then
# MacOS
if command -v brew &> /dev/null; then
brew install kubectl
else
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/darwin/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
fi

elif [ "$OS" == "windows" ]; then
# Windows
echo "Instalação automática do Kubectl não suportada no Windows."
echo "Por favor, baixe e instale Kubectl manualmente:"
echo "https://kubernetes.io/docs/tasks/tools/install-kubectl/"
echo "Após a instalação, reabra o terminal e execute este script novamente."
exit 1
fi

# Verificar a instalação
if ! command -v kubectl &> /dev/null; then
echo "Falha ao instalar o Kubectl. Por favor, instale manualmente."
exit 1
fi

echo "Kubectl instalado com sucesso!"
}

# Baixar o binário do Girus CLI
download_and_install

# Verificar as dependências necessárias
check_and_install_kind
check_and_install_kubectl

# Perguntar se o usuário deseja instalar o girus no PATH
if [ "$OS" != "windows" ]; then
read -p "Deseja instalar o Girus CLI em /usr/local/bin? (S/n): " INSTALL_CHOICE
INSTALL_CHOICE=${INSTALL_CHOICE:-S}

if [[ "$INSTALL_CHOICE" =~ ^[Ss]$ ]]; then
echo "Instalando o Girus CLI em /usr/local/bin..."
sudo mv "./girus" /usr/local/bin/
echo "Instalação concluída! Você pode agora usar o comando 'girus' no terminal."
else
# Copiar para o diretório original de onde o script foi executado
cp "./girus" "$ORIGINAL_DIR/"
echo "O binário está disponível em $ORIGINAL_DIR/girus"
echo "Você pode movê-lo manualmente para um diretório no PATH quando desejar."
fi
else
# Copiar para o diretório original de onde o script foi executado
cp "./girus.exe" "$ORIGINAL_DIR/"
echo "O binário está disponível em $ORIGINAL_DIR/girus.exe"
echo "No Windows, recomendamos mover o arquivo para uma pasta no seu PATH manualmente."
fi

# Voltar para o diretório original
cd "$ORIGINAL_DIR"

# Limpar diretório temporário
rm -rf "$TEMP_DIR"

# Verificar se Docker está instalado e em execução
if ! command -v docker &> /dev/null; then
echo "⚠️ Aviso: Docker não encontrado."
echo "O Docker é necessário para criar clusters Kind e executar o Girus."
echo "Por favor, instale o Docker adequado para seu sistema operacional:"
echo " - Linux: https://docs.docker.com/engine/install/"
echo " - macOS: https://docs.docker.com/desktop/install/mac-install/"
echo " - Windows: https://docs.docker.com/desktop/install/windows-install/"
else
# Verificar se o Docker está em execução
if ! docker info &> /dev/null; then
echo "⚠️ Aviso: Docker não está em execução."
echo "Inicie o Docker antes de criar clusters com o Girus."
else
echo "✅ Docker está instalado e em execução."
fi
fi

echo "=== Instalação do Girus CLI concluída ==="
echo "Para começar, execute:"
echo " girus create cluster # Cria um cluster Kubernetes com Girus"
echo " girus list labs # Lista os laboratórios disponíveis"
echo " girus help # Mostra ajuda e comandos disponíveis"